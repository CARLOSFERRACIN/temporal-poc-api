# Cursor Rules - Temporal POC API

## ‚úÖ Configuration WORKING 100%

### Nexus with .NET SDK 1.9.0 (Pre-Release)

**IMPORTANT**: This configuration has been tested and is WORKING PERFECTLY:

#### Dynamic Config (`config/dynamicconfig/docker.yaml`)
```yaml
system.enableNexus:
  - value: true
    constraints: {}

component.nexusoperations.callback.endpoint.template:
  - value: "http://127.0.0.1:7243/namespaces/{{.NamespaceName}}/nexus/callback"
    constraints: {}

component.callbacks.allowedAddresses:
  - value:
      - Pattern: "*"
        AllowInsecure: true
```

**CRITICAL NOTE**: 
- Port is **7243** (internal HTTP endpoint of Temporal)
- This configuration is **MANDATORY** even if HTTP callback fails with 404
- Worker processes via **polling**, not via HTTP callback
- HTTP callback will fail, but this is expected and doesn't affect functionality

#### How it works:
1. ExternalDomainWorkflow calls TransactionWorkflow via Nexus
2. TransactionWorkflow executes successfully
3. Temporal tries to send HTTP callback (fails with 404)
4. ExternalDomainWorkflow Worker receives result via **polling**
5. ExternalDomainWorkflow completes successfully

## üìÅ Project Structure

- `Temporal.POC.api/` - Main API with TransactionWorkflow and Nexus Service Handler
- `Temporal.POC.ExternalDomain.api/` - External API that calls TransactionWorkflow via Nexus
- Projects are **independent** - communication only via Nexus

## üê≥ Docker Compose

- `temporal` - Temporal Server (port 7233)
- `temporal-ui` - Temporal UI (port 8080)
- `postgresql` - Temporal database
- `api` - Main API (port 5000)
- `external-domain-api` - External API (port 6000)
- `init-search-attributes` - Initializes search attributes
- `init-nexus-endpoint` - Creates Nexus endpoint automatically

## üìù Documentation

- **DO NOT create .md files** unless the user explicitly requests
- **EXCEPTION**: `TEST-COMMANDS.md` contains necessary CURLs for testing

## üîß Temporal Configuration

- Configuration in `appsettings.json` and `appsettings.Development.json`
- `TemporalConfig` class for strong typing
- Namespace: `default` for both projects
- Dynamic Config: **MANDATORY** for Nexus to work

## üöÄ Nexus

- **.NET SDK**: 1.9.0 (Pre-Release)
- **NexusRpc Package**: 0.2.0
- **Endpoint**: `transaction-nexus-endpoint`
- **Target Namespace**: `default`
- **Target Task Queue**: `default-task-queue`
- **Custom Worker**: `TemporalWorkerService` (required to register Nexus Service)

### Nexus Service Handler
- `TransactionServiceHandler` registered in Worker via `options.AddNexusService()`
- Custom Worker because `AddHostedTemporalWorker` doesn't support `AddNexusService` in SDK 1.9.0

### How Nexus works:
- Callbacks work via **Worker polling**, not via HTTP endpoints
- .NET SDK 1.9.0 doesn't expose HTTP server for callbacks
- HTTP callback will fail with 404, but this is **EXPECTED and CORRECT**
- Worker processes results via task queue polling

## üß™ Tests

All CURL commands are in: **[TEST-COMMANDS.md](TEST-COMMANDS.md)**

### Quick Nexus test:
```bash
curl -X POST http://localhost:6000/v1/external-domain/transaction \
  -H "Content-Type: application/json" \
  -d '{"profileId":1010,"externalOperationId":"OP-NEXUS-001","operationType":"RadiusMailOrder"}'
```

### Send Stripe signal (Success):
```bash
curl -X POST http://localhost:5000/v1/stripe-signal \
  -H "Content-Type: application/json" \
  -d '{"ExternalOperationId":"OP-NEXUS-001","OperationType":"RadiusMailOrder","Success":true,"Message":"Stripe payment confirmed"}'
```

### Send Stripe signal (Failure - triggers Rollback):
```bash
curl -X POST http://localhost:5000/v1/stripe-signal \
  -H "Content-Type: application/json" \
  -d '{"ExternalOperationId":"OP-NEXUS-001","OperationType":"RadiusMailOrder","Success":false,"Message":"Stripe payment failed"}'
```

### Verify success:
```bash
docker logs temporal-poc-external-domain-api | grep "Transaction completed via Nexus"
```

## ‚ö†Ô∏è NEVER DO

1. **NEVER** remove `config/dynamicconfig/docker.yaml` file
2. **NEVER** remove `component.nexusoperations.callback.endpoint.template` configuration
3. **NEVER** change port from 7243 to another
4. **NEVER** try to create HTTP controllers to receive Nexus callbacks in SDK 1.9.0
5. **NEVER** remove `init-nexus-endpoint` service from docker-compose.yml
6. **NEVER** delete `TEST-COMMANDS.md` without consulting the user
